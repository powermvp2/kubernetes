name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: terraform-ecr

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    # 1ë‹¨ê³„: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v3
    
    # 2ë‹¨ê³„: ì´ë¯¸ì§€ íƒœê·¸ ê²°ì •
    - name: Set image tag
      id: image_tag
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Git íƒœê·¸ê°€ ìˆìœ¼ë©´ íƒœê·¸ ì‚¬ìš© (ì˜ˆ: v3.0.0)
          TAG=${GITHUB_REF#refs/tags/}
          USE_STABLE="true"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "use_stable=$USE_STABLE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version release: $TAG"
        elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
          # main ë¸Œëœì¹˜ë©´ stable íƒœê·¸ ì‚¬ìš©
          TAG=main-${{ github.sha }}
          USE_STABLE="true"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "use_stable=$USE_STABLE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Main branch: $TAG + stable"
        else
          # develop ë“± ë‹¤ë¥¸ ë¸Œëœì¹˜
          TAG=dev-${{ github.sha }}
          USE_STABLE="false"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "use_stable=$USE_STABLE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Development: $TAG"
        fi
    
    # 3ë‹¨ê³„: AWS ì¸ì¦
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    # 4ë‹¨ê³„: ECR ë¡œê·¸ì¸
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    # 5ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
        USE_STABLE: ${{ steps.image_tag.outputs.use_stable }}
      run: |
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        echo "ğŸ”¨ Building Docker image..."
        docker build -t $IMAGE_URI .
        
        echo "ğŸ“¤ Pushing image with tag: $IMAGE_TAG"
        docker push $IMAGE_URI
        
        # stable íƒœê·¸ ì¶”ê°€ (main ë¸Œëœì¹˜ ë˜ëŠ” ë²„ì „ íƒœê·¸ì¼ ë•Œ)
        if [[ "$USE_STABLE" == "true" ]]; then
          echo "ğŸ·ï¸  Tagging as stable..."
          docker tag $IMAGE_URI $ECR_REGISTRY/$ECR_REPOSITORY:stable
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:stable
          echo "âœ… Stable tag updated!"
        fi
        
        echo "âœ… Image pushed: $IMAGE_URI"
    
    # 6ë‹¨ê³„: ê²°ê³¼ ì¶œë ¥
    - name: Print result
      run: |
        echo "=========================================="
        echo "âœ… CI Pipeline Success!"
        echo "=========================================="
        echo "ğŸ“¦ Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image_tag.outputs.tag }}"
        echo "ğŸ·ï¸  Tag: ${{ steps.image_tag.outputs.tag }}"
        if [[ "${{ steps.image_tag.outputs.use_stable }}" == "true" ]]; then
          echo "ğŸ¯ Stable: YES (stable tag updated)"
        else
          echo "ğŸ¯ Stable: NO (development only)"
        fi
        echo "=========================================="
